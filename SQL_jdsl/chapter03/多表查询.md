### 第 3 章 多表查询
#### 3.5 从一个表里检索与另一个表不相关的行
**问题**
两个表有相同的键，想在一个表里查找与另一个表不相匹配的行。例如，想找出哪些部门没有员工。

**解决方案**
```SQL
SELECT d.*
FROM dept AS d LEFT OUTER JOIN emp AS e
ON d.deptno = e.deptno
WHERE e.deptno IS NULL;
```

**原因**
基于共同列把两个表连接起来，返回一个表的所有行，不论这些行在另一个表里是否存在匹配，然后只保留那些不匹配的行即可。

#### 3.6 新增连接查询而不影响其他连接查询
**问题**
已经有一个查询语句，它可以返回想要的数据，现在需要一些额外信息，但当试图获取这些信息时，却丢失了原有查询结果集中的数据。例如，想查找所有员工的信息，包括他们所在部门的位置，以及他们收到奖金的日期。

**解决方案**
```SQL
/* 使用外连接 */
SELECT e.ename, d.loc, eb.received
FROM emp AS e JOIN dept AS d
ON e.deptno = d.deptno
LEFT OUTER JOIN emp_bonus AS eb 
ON e.empno = eb.empno
ORDER BY 2;

/* 使用标量子查询（即把子查询放置在 SELECT 列表里）来模仿外连接操作，标量子查询适用于所有数据库 */
SELECT e.ename, d.loc,
    (SELECT eb.received FROM emp_bonus AS eb WHERE e.empno = eb.empno) AS received
FROM emp AS e, dept AS d
WHERE e.deptno = d.deptno
ORDER BY 2;
```

**原因**
使用标量子查询是解决本问题的一种巧妙做法，因为不需要修改主查询中正确的连接操作。在不破坏当前结果集的情况下，标量子查询是为现有查询语句添加额外数据的好办法。当使用标量子查询时，必须确保它们返回的是标量值（单值）。如果 SELECT 列表里的子查询返回多行，那么查询将会出错。

#### 3.9 组合使用连接查询与聚合函数
**问题**
执行一个涉及多个表的聚合操作，但需要确保表之间的连接查询不会干扰聚合操作。例如，计算部门编号为 10 的员工的工资总额以及奖金总和。因为有部分员工多次获得奖金，所以在 emp 表和 emp_bonus 表连接之后再执行聚合函数 SUM，就会得出错误的计算结果。

**解决方案**
```SQL
/* 调用聚合函数时使用 DISTINCT，这样每个值都会先去掉重复项再计算 */
SELECT deptno,
    SUM(DISTINCT sal) AS total_sal.
    SUM(bonus) AS total_bonus
FROM (
          SELECT e.empno, e.ename, e.sal, e.deptno, 
          e.sal * CASE WHEN eb.type = 1 THEN 0.1
              WHEN eb.type = 2 THEN 0.2
              ELSE 0.3
          END AS bonus
          FROM emp AS e, emp_bonus AS eb
          WHERE e.empno = eb.empno
          AND e.deptno = 10
     ) AS x
GROUP BY deptno;

/* 在连接查询之前先执行聚合运算 */
SELECT d.deptno,
       d.total_sal,
       SUM(e.sal * CASE WHEN eb.type = 1 THEN 0.1
               WHEN eb.type = 2 THEN 0.2
               ELSE 0.3 END) AS total_bonus
FROM emp AS e, emp_bonus AS eb, (
    SELECT deptno, SUM(sal) AS total_sal 
    FROM emp
    WHERE deptno = 10
    GROUP BY deptno
        ) AS d
WHERE e.deptno = d.deptno
AND e.empno = eb.empno
GROUP BY d.deptno, d.total_sal;
```

#### 3.11 从多个表中返回缺失值
**问题**
在同一个查询语句中既外连接到 emp 表，又外连接到 dept 表。

**解决方案**
```SQL
/* 使用全连接从两个表中返回缺失的行以及相匹配的行 */
SELECT d.deptno, d.dname, e.ename
FROM dept AS d FULL OUTER JOIN emp AS e
ON d.deptno = e.deptno;

/* 合并两个外连接 */
SELECT d.deptno, d.dname, e.ename
FROM dept AS d RIGHT OUTER JOIN emp AS e
ON d.deptno = e.deptno
UNION 
SELECT d.deptno, d.name, e.ename
FROM dept AS d LEFT OUTER JOIN emp AS e
ON d.deptno = e.deptno;
```

**原因**
全连接查询其实就是合并两个表外连接查询的结果集。
